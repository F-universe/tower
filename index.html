<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover"/>
  <title>Neon Conquest ‚Äî build mobile</title>
  <style>
    /* Nascondi eventuale pulsante entrate (richiesta precedente) */
    #upInc { display:none !important; }

    :root { --accent:#00e5ff; --text:#eaf8ff; }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{
      margin:0; color:var(--text);
      font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial;
      display:flex; flex-direction:column; gap:8px;
      background:#0a1224;
    }

    header{
      display:flex; align-items:center; gap:12px; flex-wrap:wrap;
      padding:10px clamp(10px,2vw,20px);
      background:rgba(10,18,36,.55); backdrop-filter:saturate(130%) blur(2px);
      border-bottom:1px solid rgba(255,255,255,.08)
    }
    .brand{ font-weight:800; letter-spacing:.3px }
    .brand span{ color:var(--accent) }
    .stat{ margin-left:auto; display:flex; gap:14px; font-weight:600; flex-wrap:wrap }
    .stat b{ color:var(--accent) }

    /* Barra comandi: scorrevole in mobile */
    .bar{ position:relative; display:flex; gap:8px; align-items:center; padding:8px 10px 12px 10px; flex-wrap:wrap }
    .bar button{
      background:rgba(12,24,48,.72); color:var(--text);
      border:1px solid rgba(255,255,255,.12); border-radius:12px;
      padding:9px 12px; cursor:pointer; font-weight:700; letter-spacing:.2px;
      box-shadow:inset 0 0 18px rgba(0,229,255,.10), 0 0 8px rgba(0,229,255,.18);
      transition:transform .05s ease, box-shadow .2s ease
    }
    .bar button:active{ transform:translateY(1px) }
    .sep{ opacity:.7 }

    /* In portrait stringiamo e rendiamo la bar scorrevole (orizzontale) */
    @media (orientation: portrait) {
      .bar{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:calc(env(safe-area-inset-bottom,0px) + 10px) }
      .bar::-webkit-scrollbar{ display:none }
      .bar button{ padding:12px 14px; font-size:14px; white-space:nowrap }
      header .stat div:nth-child(3),
      header .stat div:nth-child(5){ display:none } /* nasconde alcune info per schermi piccoli */
    }

    /* Menu */
    #upMenu, #spellMenu, #mineMenu{
      position:absolute; min-width:320px; display:none; z-index:50;
      background:rgba(14,28,60,.96);
      border:1px solid rgba(255,255,255,.12); border-radius:12px;
      box-shadow:0 12px 40px rgba(0,0,0,.5); padding:8px;
      max-width:min(92vw, 440px);
    }
    #upMenu .item, #spellMenu .item, #mineMenu .item{
      width:100%; text-align:left; margin:4px 0; padding:10px 12px;
      background:rgba(18,36,72,.85); border:1px solid rgba(255,255,255,.08);
      border-radius:10px; cursor:pointer; font-weight:800; line-height:1.25;
    }
    #upMenu .sub, #spellMenu .sub, #mineMenu .sub{
      display:block; font-size:.85rem; opacity:.85; font-weight:600; margin-top:2px
    }
    #spellMenu .item[aria-disabled="true"]{ opacity:.45; filter:grayscale(30%); pointer-events:none; font-weight:700 }

    #gameWrap{ position:relative; flex:1; margin:0 }
    canvas{ position:absolute; inset:0; width:100%; height:100%; background:transparent; touch-action:none; }
    canvas.aim{ cursor: crosshair; }

    /* Overlay fine partita */
    #overlay{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      backdrop-filter:blur(3px);
      background:radial-gradient(800px 400px at 50% 40%, rgba(0,229,255,.06), rgba(0,0,0,.55))
    }
    .modal{
      background:rgba(14,28,60,.9); border:1px solid rgba(255,255,255,.12);
      border-radius:18px; padding:22px; text-align:center; box-shadow:0 15px 60px rgba(0,0,0,.6)
    }

    /* Intro livello */
    #levelIntro{
      position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:60;
      background:
        radial-gradient(1200px 500px at 50% 30%, rgba(0,229,255,.10), rgba(0,0,0,.65)),
        linear-gradient(180deg, rgba(0,229,255,.06), rgba(0,0,0,.65));
      overflow:hidden;
    }
    #levelIntro .pulse{
      position:absolute; inset:0; pointer-events:none;
      background:
        repeating-linear-gradient(90deg, rgba(0,229,255,.12), rgba(0,229,255,.12) 1px, transparent 1px, transparent 20px),
        repeating-linear-gradient(0deg, rgba(0,229,255,.08), rgba(0,229,255,.08) 1px, transparent 1px, transparent 20px);
      animation: gridPulse 3s linear infinite;
      mix-blend-mode:screen;
    }
    @keyframes gridPulse{ 0%{transform:translateY(0)} 100%{transform:translateY(20px)} }
    #levelIntro h1{
      font-size: clamp(30px, 6vw, 88px);
      margin:0; letter-spacing:2px; text-transform:uppercase;
      background:linear-gradient(90deg,#aaf5ff,#00e5ff,#aaf5ff);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 28px rgba(0,229,255,.55);
      filter: drop-shadow(0 10px 40px rgba(0,0,0,.6));
    }
    #levelIntro p{ margin:.4rem 0 0 0; opacity:.9; font-weight:700; }

    footer{ padding:0; margin:0; height:0; overflow:hidden }
  </style>
</head>
<body>
  <header>
    <div class="brand">üè∞ <span>Neon</span> Conquest ‚Äî mobile</div>
    <div class="stat">
      <div>‚ö° Energia: <b id="energyP">0</b></div>
      <div>üõ°Ô∏è Mia Torre: <b id="hpP">‚Äî</b></div>
      <div>üèØ Torre Nemica: <b id="hpE">‚Äî</b></div>
      <div>‚è±Ô∏è Velocit√†: <b id="speedLbl">1x</b></div>
      <div>üìà Livello: <b id="lvlLbl">1</b></div>
    </div>
  </header>

  <div class="bar" id="bar">
    <button id="spawnWarrior">üó°Ô∏è Guerriero (50)</button>
    <button id="spawnCrossbow">üèπ Balestriere (80)</button>
    <button id="spawnGolem">üóø Golem (120)</button>
    <button id="spawnWizard">üßô‚Äç‚ôÇÔ∏è Mago (400)</button>
    <button id="spawnBabyWizard">üßô‚Äç‚ôÇÔ∏è‚ú® Baby Mago Blu (700)</button>
    <span class="sep">|</span>

    <button id="btnUpgrades">üõ†Ô∏è Potenziamenti</button>
    <span class="sep">|</span>

    <button id="btnSpells">‚ú® Incantesimi</button>
    <span class="sep">|</span>

    <!-- Miniere -->
    <button id="placeMine">‚õèÔ∏è Miniera (‚Äî)</button>
    <button id="btnMines">üì¶ Miniere</button>
    <span class="sep">|</span>

    <button id="toggleSpeed">‚ö° 2x</button>
    <button id="togglePause">‚èØÔ∏è Pausa</button>
    <span class="sep">|</span>
    <button id="nextLvl">‚ñ∂Ô∏è Prossima Ondata</button>

    <!-- Menu potenziamenti (unit√† + globali + incantesimi) -->
    <div id="upMenu" role="menu" aria-hidden="true"></div>

    <!-- Menu incantesimi (uso/cast) -->
    <div id="spellMenu" role="menu" aria-hidden="true"></div>

    <!-- Menu Miniere -->
    <div id="mineMenu" role="menu" aria-hidden="true"></div>
  </div>

  <main id="gameWrap">
    <canvas id="game"></canvas>

    <!-- Intro livello -->
    <div id="levelIntro">
      <div class="pulse"></div>
      <div class="modal" style="background:rgba(14,28,60,.85);border-radius:22px;padding:26px 26px 20px 26px;border:1px solid rgba(255,255,255,.12);box-shadow:0 15px 60px rgba(0,0,0,.7)">
        <h1 id="introTitle">LIVELLO 1</h1>
        <p id="introDesc">Nuova ondata in arrivo‚Ä¶ preparati!</p>
      </div>
    </div>

    <!-- Fine partita -->
    <div id="overlay">
      <div class="modal">
        <h2 id="endTitle">‚Äî</h2>
        <p id="endDesc" style="opacity:.85;margin:.2rem 0 1rem 0">‚Äî</p>
        <div style="display:flex;gap:10px;justify-content:center">
          <button id="restartBtn">üîÅ Riavvia</button>
          <button id="contBtn">üéØ Nuova Partita</button>
        </div>
      </div>
    </div>
  </main>
  <footer></footer>

  <script>
  'use strict';

  /* ===== Utility ===== */
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function rnd(a,b){ return Math.random()*(b-a)+a; }
  function groundY(){ return canvas.height - 90; } // bordo superiore fascia scura
  var HP_GREEN = '#20ffa8';

  /* ===== Bilanciamento e costanti ===== */
  const MAX_UNIT_LVL = 30;          // max livello potenziamenti unit√†
  const MAX_SPELL_LVL = 30;         // max livello potenziamenti incantesimi
  const SPAWN_STEP   = 1.10;        // +10% costo evocazione per livello unit√†
  const SPELL_CAST_STEP = 1.10;     // costo cast cresce coi livelli incantesimo
  const ENERGY_DECAY = 0.0018;      // (ridotto del 40% dal 0.003) ‚Äî non usato con incomeFall=1

  /* ===== Canvas ===== */
  var canvas = document.getElementById('game');
  var ctx = canvas.getContext('2d');
  var wrap = document.getElementById('gameWrap');
  function resize(){
    var w=wrap.clientWidth, h=wrap.clientHeight;
    var isPortrait = w < h;
    var r = isPortrait ? 9/16 : 16/9; // usa 9:16 in verticale
    var cw=w, ch=Math.floor(w/r);
    if(ch>h){ ch=h; cw=Math.floor(h*r); }
    canvas.width=cw; canvas.height=ch;
  }
  addEventListener('resize', resize);

  /* ===== Immagini ===== */
  var bgImg=new Image(), bgReady=false; bgImg.onload=function(){ bgReady=true; }; bgImg.src='new.png';
  var tImgP=new Image(), tReadyP=false; tImgP.onload=function(){ tReadyP=true; }; tImgP.src='torre1.png';
  var tImgE=new Image(), tReadyE=false; tImgE.onload=function(){ tReadyE=true; }; tImgE.src='torre2.png';

  // Alleati
  var imgAlien=new Image(), readyAlien=false; imgAlien.onload=function(){ readyAlien=true; }; imgAlien.src='alien.png';
  var imgGolem=new Image(), readyGolem=false; imgGolem.onload=function(){ readyGolem=true; }; imgGolem.src='golem.png';
  var imgSoldier1=new Image(), readySoldier1=false; imgSoldier1.onload=function(){ readySoldier1=true; }; imgSoldier1.src='soldier1.png';
  var imgWizard=new Image(), readyWizard=false; imgWizard.onload=function(){ readyWizard=true; }; imgWizard.src='wizard.png';
  var imgMiniWizard=new Image(), readyMiniWizard=false; imgMiniWizard.onload=function(){ readyMiniWizard=true; }; imgMiniWizard.src='minimago.png';

  // Nemici
  var imgAlien2=new Image(), readyAlien2=false; imgAlien2.onload=function(){ readyAlien2=true; }; imgAlien2.src='alien2.png';
  var imgGolem2=new Image(), readyGolem2=false; imgGolem2.onload=function(){ readyGolem2=true; }; imgGolem2.src='golem2.png';
  var imgGolemPrime=new Image(), readyGolemPrime=false; imgGolemPrime.onload=function(){ readyGolemPrime=true; }; imgGolemPrime.src='golem2.1.png';
  var imgGolem22=new Image(), readyGolem22=false; imgGolem22.onload=function(){ readyGolem22=true; }; imgGolem22.src='golem2.2.png';
  var imgGoblin2=new Image(), readyGoblin2=false; imgGoblin2.onload=function(){ readyGoblin2=true; }; imgGoblin2.src='goblin2.png';
  var imgSoldier2=new Image(), readySoldier2=false; imgSoldier2.onload=function(){ readySoldier2=true; }; imgSoldier2.src='soldier2.png';

  // Proiettili / Effetti esistenti
  var imgFire=new Image(), readyFire=false; imgFire.onload=function(){ readyFire=true; }; imgFire.src='fuoco.png';
  var imgBoom=new Image(), readyBoom=false; imgBoom.onload=function(){ readyBoom=true; }; imgBoom.src='boom.png';
  var imgFireB=new Image(), readyFireB=false; imgFireB.onload=function(){ readyFireB=true; }; imgFireB.src='fuocoblu.png';
  var imgBoom2=new Image(), readyBoom2=false; imgBoom2.onload=function(){ readyBoom2=true; }; imgBoom2.src='boom2.png';

  // Incantesimi (sprite)
  var imgL1=new Image(), rL1=false; imgL1.onload=function(){ rL1=true; }; imgL1.src='fulmine1.png';
  var imgL2=new Image(), rL2=false; imgL2.onload=function(){ rL2=true; }; imgL2.src='fulmine2.png';
  var imgL3=new Image(), rL3=false; imgL3.onload=function(){ rL3=true; }; imgL3.src='fulmine3.png';

  var imgF1=new Image(), rF1=false; imgF1.onload=function(){ rF1=true; }; imgF1.src='incendio1.png';
  var imgF2=new Image(), rF2=false; imgF2.onload=function(){ rF2=true; }; imgF2.src='incendio2.png';
  var imgF3=new Image(), rF3=false; imgF3.onload=function(){ rF3=true; }; imgF3.src='incendio3.png';

  var imgS1=new Image(), rS1=false; imgS1.onload=function(){ rS1=true; }; imgS1.src='gelo1.png';
  var imgS2=new Image(), rS2=false; imgS2.onload=function(){ rS2=true; }; imgS2.src='gelo2.png';
  var imgS3=new Image(), rS3=false; imgS3.onload=function(){ rS3=true; }; imgS3.src='gelo3.png';

  /* ===== PNG Miniere ===== */
  var imgMine1=new Image(), rM1=false; imgMine1.onload=function(){ rM1=true; }; imgMine1.src='miniera1.png';
  var imgMine2=new Image(), rM2=false; imgMine2.onload=function(){ rM2=true; }; imgMine2.src='miniera2.png';
  var imgMine3=new Image(), rM3=false; imgMine3.onload=function(){ rM3=true; }; imgMine3.src='miniera3.png';

  /* ===== Stato ===== */
  var state={
    time:0, dt:0, last:0, speed:1, paused:false, level:1,
    incomeP:6, incomeE:6, energyP:180, energyE:180,
    dmgMulP:1, incomeMulP:1, incomeFall:1, unitSpeedMul:0.35,

    // upgrade unit√†: DMG + HP separati (HP ~ +2% rispetto al danno)
    unitUp:{
      Warrior:{lvl:0, dmg:1.00, hp:1.00},
      Crossbow:{lvl:0, dmg:1.00, hp:1.00},
      Golem:{lvl:0, dmg:1.00, hp:1.00},
      Wizard:{lvl:0, dmg:1.00, hp:1.00},
      BabyWizard:{lvl:0, dmg:1.00, hp:1.00}
    },

    // globali (+1% ciascuno)
    globalUp:{ dmg:0, inc:0 },

    // incantesimi (potenziabili)
    spells:{
      lightning:{cost:250, dmg:70, unlockLvl:2, lvl:0, mul:1.00},
      fire:{cost:600, impact:400, dot:100, dotDur:5, unlockLvl:4, lvl:0, mul:1.00},
      slow:{cost:800, factor:0.4, dur:20, unlockLvl:6, lvl:0, mul:1.00}
    },
    targeting:null,
    aimX:null,

    /* Miniere: 40% meno rendimento, +40% costi di piazzamento/upgrade */
    minePlaceCost: Math.round(500*1.4),
    mines:[],
    mineRates:[21,33,60,120],
    mineCosts:[Math.round(500*1.4), Math.round(700*1.4), Math.round(1200*1.4)],
    maxMines:3,

    entities:[], projectiles:[], effects:[],
    towers:{ P:{x:70,y:0,w:44,h:260,hp:1200,max:1200}, E:{x:0,y:0,w:44,h:260,hp:1200,max:1200} },
    ai:{ timer:0, cadence:3.2, spawnCount:0 },
    maxEnemies:22
  };

  // upgrade per-unit√† (danno/HP)
  var UP={
    Warrior:{base:120, step:1.35, bonusD:0.12, bonusH:0.14},
    Crossbow:{base:160, step:1.35, bonusD:0.12, bonusH:0.14},
    Golem  :{base:220, step:1.35, bonusD:0.12, bonusH:0.14},
    Wizard :{base:320, step:1.35, bonusD:0.12, bonusH:0.14},
    BabyWizard:{base:520, step:1.35, bonusD:0.12, bonusH:0.14}
  };

  // potenziamenti incantesimi (dentro menu potenziamenti)
  var SPELL_UP={
    lightning:{base:220, step:1.35, bonus:0.12},
    fire     :{base:280, step:1.35, bonus:0.12},
    slow     :{base:260, step:1.35, bonus:0.10}
  };

  function enemyScale(){ return Math.pow(1.05, Math.max(0, state.level-1)); }
  function format(n){ return Math.round(n); }

  function reset(){
    resize();
    state.entities.length=0; state.projectiles.length=0; state.effects.length=0;
    state.time=0; state.last=performance.now(); state.dt=0; state.speed=1; state.paused=false;
    state.level=1; state.incomeP=6; state.incomeE=6; state.energyP=180; state.energyE=180;
    state.dmgMulP=1; state.incomeMulP=1; state.incomeFall=1; state.unitSpeedMul=0.35;

    state.towers.P.max=1200; state.towers.E.max=1200;
    state.towers.P.hp=1200;  state.towers.E.hp=1200;

    state.ai.timer=0; state.ai.cadence=3.2; state.ai.spawnCount=0; state.maxEnemies=22;
    state.targeting=null; state.aimX=null;

    state.mines = [];

    // reset incantesimi
    state.spells.lightning.lvl=0; state.spells.lightning.mul=1.00;
    state.spells.fire.lvl=0; state.spells.fire.mul=1.00;
    state.spells.slow.lvl=0; state.spells.slow.mul=1.00;

    var g=groundY();
    state.towers.P.y=g; state.towers.E.y=g; state.towers.E.x=canvas.width-70;

    updateHUD(); hideOverlay();
    renderUpMenu(); updateSpellLabels(); renderMineMenu(); updateSpawnButtons(); updateMineButtons();

    // intro livello
    showLevelIntro();
  }

  /* ===== Slow factor da campi di gelo ===== */
  function slowFactorFor(unit){
    if(unit.side!=='E') return 1;
    var mul=1;
    for(var i=0;i<state.effects.length;i++){
      var e=state.effects[i];
      if(!e || !e.isSlowField) continue;
      if(e.t>=e.dur) continue;
      var dx=unit.x - e.x, dy=unit.y - e.y, r2=e.r*e.r;
      if(dx*dx+dy*dy <= r2){ mul = Math.min(mul, e.factor); }
    }
    return mul;
  }

  /* ===== Unit√† ===== */
  function Unit(side,type){
    this.side=side; this.type=type; var base=Unit.types[type];
    var sc = (side==='E') ? enemyScale() : 1;

    // moltiplicatori player (DMG/HP)
    var u = (side==='P' && state.unitUp[type]) ? state.unitUp[type] : null;
    var dmgMul = u ? u.dmg : 1;
    var hpMul  = u ? u.hp  : 1;

    this.baseDamage = base.damage*sc;
    this.damageMul  = dmgMul;
    this.maxHp = base.hp*sc*hpMul;
    this.hp    = this.maxHp;

    this.speed=base.speed; this.range=base.range; this.cool=base.cool; this.timer=0;
    this.reward=base.reward; this.cost=base.cost; this.ranged=base.ranged; this.size=base.size;

    this.y = groundY();
    this.x = (side==='P') ? (state.towers.P.x - state.towers.P.w/2 - 30)
                          : (state.towers.E.x + state.towers.E.w/2 + 30);
    this.dir=(side==='P')? 1 : -1;
    this.shake=0;
    this.lastTargetX=null;

    if(type==='EGolemPrime'){ this.spawnEvery=3; this.spawnTimer=this.spawnEvery; }
    if(type==='EGolemRoll'){ this.angle=0; this.rollR = this.size*1.25; }
  }

  Unit.prototype.update=function(dt){
    if(this.shake>0) this.shake=Math.max(0, this.shake - dt*4);
    if(this.type==='EGolemPrime'){
      this.spawnTimer -= dt;
      if(this.spawnTimer<=0){
        this.spawnTimer += this.spawnEvery;
        var g = new Unit('E','EGoblin');
        g.x = this.x + rnd(-12,12); g.y=this.y;
        state.entities.push(g);
      }
    }
    var foes=state.entities.filter(function(e){return e.side!==this.side;}, this);
    var target=null, best=1e9, i, f, d;
    for(i=0;i<foes.length;i++){
      f=foes[i]; d=Math.abs(f.x-this.x);
      if((this.dir>0 && f.x>=this.x) || (this.dir<0 && f.x<=this.x)){
        if(d<best){ best=d; target=f; }
      }
    }
    if(target) this.lastTargetX = target.x;
    if(!target){ target=(this.side==='P')? state.towers.E : state.towers.P; best=Math.abs(target.x-this.x); }
    if(best<=this.range){ this.timer-=dt; if(this.timer<=0){ this.attack(target); this.timer=this.cool; } }
    else {
      var slowMul = slowFactorFor(this);
      var step = this.speed*state.unitSpeedMul*slowMul*this.dir*dt*60;
      this.x += step; this.x=clamp(this.x, 20, canvas.width-20);
      if(this.type==='EGolemRoll'){ this.angle -= Math.abs(step) / (this.rollR || 40); }
    }
  };

  Unit.prototype.attack=function(target){
    // danno effettivo = base √ó upgradeUnit.dmg √ó (dmg globale se Player)
    var dmgEff = this.baseDamage * (this.side==='P' ? this.damageMul*state.dmgMulP : 1);

    // maghi lanciano AoE
    if(this.side==='P' && (this.type==='Wizard' || this.type==='BabyWizard')){
      this.shake = 0.25;
      var tx = (this.lastTargetX!==null)? this.lastTargetX : (this.x + 200*this.dir);
      if(this.type==='Wizard'){
        state.projectiles.push(new Projectile(tx, -60, 0, this.side, dmgEff, 'fire', false, {vy:520, radius:70}));
      }else{
        state.projectiles.push(new Projectile(tx, -60, 0, this.side, dmgEff, 'fireB', false, {vy:520, radius:70}));
      }
      return;
    }

    if(this.ranged){
      var v=(this.side==='P')? 320 : -320;
      state.projectiles.push(new Projectile(this.x,this.y-10,v,this.side,dmgEff,'bolt',true));
    } else {
      dealDamage(target,dmgEff);
    }
  };

  Unit.prototype.draw=function(){
    ctx.save();
    if(this.shake>0){
      var amp=2.2*this.shake;
      ctx.translate((Math.random()-0.5)*amp, (Math.random()-0.5)*amp);
    }

    // (come nel file originale ‚Äî con fallback se le PNG mancano)
    const t=this.type, s=this.size;
    function rect(x,y,w,h,c){ ctx.fillStyle=c; ctx.fillRect(x-w/2,y-h,w,h); }

    if(t==='Crossbow'){
      if(readyAlien){ let dh=s*1.9, sc=dh/Math.max(1,imgAlien.height), dw=imgAlien.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgAlien,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.7,s*0.7,'#7be8ff');
    } else if(t==='ECrossbow'){
      if(readyAlien2){ let dh=s*1.9, sc=dh/Math.max(1,imgAlien2.height), dw=imgAlien2.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgAlien2,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.7,s*0.7,'#ffa1c3');
    } else if(t==='Golem'){
      if(readyGolem){ let dh=s*2.3, sc=dh/Math.max(1,imgGolem.height), dw=imgGolem.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgGolem,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.9,s*0.9,'#5dd6ff');
    } else if(t==='EGolem'){
      if(readyGolem2){ let dh=s*2.3, sc=dh/Math.max(1,imgGolem2.height), dw=imgGolem2.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgGolem2,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.9,s*0.9,'#ff86b1');
    } else if(t==='EGolemPrime'){
      if(readyGolemPrime){ let dh=s*2.8, sc=dh/Math.max(1,imgGolemPrime.height), dw=imgGolemPrime.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgGolemPrime,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s,s,'#d48cff');
    } else if(t==='EGolemRoll'){
      var R=this.rollR||s*1.25, S=R*2, cy=this.y-R;
      if(readyGolem22){ ctx.translate(this.x,cy); ctx.rotate(this.angle); ctx.drawImage(imgGolem22,-S/2,-S/2,S,S); }
      else{ ctx.translate(this.x,cy); ctx.rotate(this.angle); ctx.fillStyle='#ff9bd0'; ctx.beginPath(); ctx.arc(0,0,R,0,Math.PI*2); ctx.fill(); }
    } else if(t==='EGoblin'){
      if(readyGoblin2){ let dh=s*1.6, sc=dh/Math.max(1,imgGoblin2.height), dw=imgGoblin2.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgGoblin2,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.8,s*0.8,'#88ff88');
    } else if(t==='Warrior'){
      if(readySoldier1){ let dh=s*1.9, sc=dh/Math.max(1,imgSoldier1.height), dw=imgSoldier1.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgSoldier1,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.7,s*0.7,'#39cfff');
    } else if(t==='EWarrior'){
      if(readySoldier2){ let dh=s*1.9, sc=dh/Math.max(1,imgSoldier2.height), dw=imgSoldier2.width*sc; ctx.translate(this.x,this.y); ctx.scale(-1,1); ctx.drawImage(imgSoldier2,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.7,s*0.7,'#ff5f9a');
    } else if(t==='Wizard'){
      if(readyWizard){ let dh=s*2.0, sc=dh/Math.max(1,imgWizard.height), dw=imgWizard.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgWizard,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.7,s*0.9,'#c9a7ff');
    } else if(t==='BabyWizard'){
      if(readyMiniWizard){ let dh=s*2.0, sc=dh/Math.max(1,imgMiniWizard.height), dw=imgMiniWizard.width*sc; ctx.translate(this.x,this.y); ctx.drawImage(imgMiniWizard,-dw/2,-dh,dw,dh); }
      else rect(this.x,this.y,s*0.7,s*0.9,'#7ecbff');
    }
    ctx.restore();

    // barra HP
    var bw=Math.max(20,this.size*1.1);
    ctx.fillStyle='rgba(255,255,255,.14)'; ctx.fillRect(this.x-bw/2, this.y-this.size*1.25-10, bw, 6);
    ctx.fillStyle=HP_GREEN; ctx.fillRect(this.x-bw/2, this.y-this.size*1.25-10, bw*(this.hp/this.maxHp), 6);
  };

  /* ===== Stat unit√† ===== */
  Unit.types={
    Warrior:{hp:100,speed:1.6,damage:20,range:18,cool:0.55,reward:22,cost:50 ,ranged:false,size:24},
    Crossbow:{hp:75,speed:1.15,damage:10,range:160,cool:0.8 ,reward:28,cost:80 ,ranged:true ,size:24},
    Golem  :{hp:660,speed:0.8,damage:34,range:22,cool:1.0 ,reward:42,cost:120,ranged:false,size:28},
    Wizard :{hp:70,speed:1.2,damage:45,range:210,cool:3.38,reward:55,cost:400,ranged:true ,size:26},
    BabyWizard:{hp:35,speed:1.0,damage:70,range:360,cool:4.5,reward:95,ranged:true,size:26,cost:700},

    EWarrior:{hp:75,speed:1.5,damage:12,range:18,cool:0.55,reward:0 ,cost:50 ,ranged:false,size:24},
    ECrossbow:{hp:90,speed:1.1,damage:14,range:160,cool:0.85,reward:0 ,cost:80 ,ranged:true ,size:24},

    EGolem  :{hp:500,speed:0.75,damage:36,range:22,cool:1.05,reward:0 ,ranged:false,size:28},
    EGolemPrime:{hp:250*15,speed:0.75/2,damage:36*10,range:22,cool:1.2,reward:0,cost:120,ranged:false,size:32},
    EGolemRoll:{hp:2000,speed:1,damage:90,range:22,cool:0.5,reward:0,cost:160,ranged:false,size:34},
    EGoblin:{hp:70,speed:1.8,damage:9,range:18,cool:0.6,reward:0,cost:20,ranged:false,size:20}
  };

  /* ===== Effetti rapidi ===== */
  function Boom(x,y,r,kind){ this.x=x; this.y=y; this.r=r; this.kind=kind||'fire'; this.t=0; this.dur=0.38; }
  Boom.prototype.update=function(dt){ this.t+=dt; };
  Boom.prototype.draw=function(){
    var k = Math.min(1, this.t/this.dur);
    var alpha = 1 - k, scale = 0.6 + 0.6*k;
    ctx.save(); ctx.globalAlpha = alpha; ctx.globalCompositeOperation = 'screen';
    if(this.kind==='lightning' && rL3){ var sz=this.r*2*scale; ctx.drawImage(imgL3, this.x-sz/2, this.y-sz/2, sz, sz); }
    else if(this.kind==='spellFire' && rF3){ var s2=this.r*2*scale; ctx.drawImage(imgF3, this.x-s2/2, this.y-s2/2, s2, s2); }
    else{
      var img = (this.kind==='fireB') ? imgBoom2 : imgBoom;
      var ready = (this.kind==='fireB') ? readyBoom2 : readyBoom;
      if(ready){ var s3=this.r*2*scale; ctx.drawImage(img, this.x - s3/2, this.y - s3/2, s3, s3); }
      else{
        var rad=this.r*scale, grd=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,rad);
        if(this.kind==='fireB'){ grd.addColorStop(0,'rgba(160,220,255,.95)'); grd.addColorStop(1,'rgba(40,140,255,0)'); }
        else if(this.kind==='lightning'){ grd.addColorStop(0,'rgba(200,235,255,.95)'); grd.addColorStop(1,'rgba(80,170,255,0)'); }
        else if(this.kind==='spellFire'){ grd.addColorStop(0,'rgba(255,180,80,.95)'); grd.addColorStop(1,'rgba(255,80,20,0)'); }
        else{ grd.addColorStop(0,'rgba(255,220,120,.95)'); grd.addColorStop(1,'rgba(255,120,40,0)'); }
        ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(this.x,this.y,rad,0,Math.PI*2); ctx.fill();
      }
    }
    ctx.restore();
  };

  function BurnField(x,y,r,dps,dur){ this.x=x; this.y=y; this.r=r; this.dps=dps; this.t=0; this.dur=dur; }
  BurnField.prototype.update=function(dt){
    this.t+=dt; var dmg=this.dps*dt;
    var foes=state.entities.filter(function(e){return e.side==='E';});
    var r2=this.r*this.r;
    for(var i=0;i<foes.length;i++){ var f=foes[i]; var dx=f.x-this.x, dy=f.y-this.y; if(dx*dx+dy*dy<=r2){ dealDamage(f,dmg); } }
  };
  BurnField.prototype.draw=function(){
    var k=this.t/this.dur; if(k>1) k=1;
    var alpha=0.28*(1-k)+0.18;
    ctx.save(); ctx.globalCompositeOperation='screen';
    var rad=this.r*(1+0.04*Math.sin(state.time*4));
    var grd=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,rad);
    grd.addColorStop(0,'rgba(255,160,60,'+alpha+')'); grd.addColorStop(1,'rgba(255,60,0,0)');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(this.x,this.y,rad,0,Math.PI*2); ctx.fill(); ctx.restore();
  };

  function SlowField(x,y,r,factor,dur){ this.x=x; this.y=y; this.r=r; this.factor=factor; this.t=0; this.dur=dur; this.isSlowField=true; }
  SlowField.prototype.update=function(dt){ this.t+=dt; };
  SlowField.prototype.draw=function(){
    var k=this.t/this.dur; if(k>1) k=1;
    var alpha=0.30*(1-k)+0.12;
    ctx.save(); ctx.globalCompositeOperation='screen';
    var rad=this.r*(1+0.03*Math.sin(state.time*3));
    var grd=ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,rad);
    grd.addColorStop(0,'rgba(170,220,255,'+alpha+')'); grd.addColorStop(1,'rgba(80,170,255,0)');
    ctx.fillStyle=grd; ctx.beginPath(); ctx.arc(this.x,this.y,rad,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(150,210,255,'+(alpha*1.3)+')'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(this.x,this.y,rad,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  };

  /* ===== Proiettili ===== */
  function Projectile(x,y,vx,side,damage,kind,canHitTower,opts){
    this.x=x; this.y=y; this.vx=vx; this.side=side; this.damage=damage; this.dead=false;
    this.kind=kind||'bolt'; this.canHitTower=(canHitTower!==false);
    if(opts){ this.vy=opts.vy||520; this.radius=opts.radius||70; } else { this.vy=0; this.radius=0; }
  }
  Projectile.prototype.update=function(dt){
    if(this.kind==='fire' || this.kind==='fireB' || this.kind==='lightning' || this.kind==='fireSpell' || this.kind==='slowSpell'){
      this.y += this.vy*dt;
      var gy = groundY(), impactY = gy;
      if(this.y >= impactY){
        this.y = impactY;

        if(this.kind!=='slowSpell'){
          var foes=state.entities.filter(function(e){return e.side!==this.side;}, this);
          var r2=this.radius*this.radius;
          for(var i=0;i<foes.length;i++){
            var f=foes[i]; var dx=f.x-this.x, dy=(f.y-impactY); var d2=dx*dx+dy*dy;
            if(d2<=r2){ dealDamage(f,this.damage); }
          }
          var tower = (this.side==='P')? state.towers.E : state.towers.P;
          if(Math.abs(tower.x-this.x) <= this.radius + 28){ dealDamage(tower, this.damage); }
        }

        if(this.kind==='lightning'){
          state.effects.push(new Boom(this.x, impactY, this.radius, 'lightning'));
        }else if(this.kind==='fireSpell'){
          state.effects.push(new Boom(this.x, impactY, this.radius, 'spellFire'));
          var dps = (state.spells.fire.dot * state.spells.fire.mul) * state.dmgMulP;
          var dur = state.spells.fire.dotDur + 2*state.spells.fire.lvl;
          state.effects.push(new BurnField(this.x, impactY, this.radius, dps, dur));
        }else if(this.kind==='slowSpell'){
          var effFactor = Math.max(0.2, state.spells.slow.factor * Math.pow(0.96, state.spells.slow.lvl));
          var effDur = state.spells.slow.dur + 2*state.spells.slow.lvl;
          state.effects.push(new SlowField(this.x, impactY, this.radius, effFactor, effDur));
        }else{
          state.effects.push(new Boom(this.x, impactY, this.radius, this.kind));
        }
        this.dead=true;
      }
      if(this.y>canvas.height+120) this.dead=true;
      return;
    }

    // proiettile standard
    this.x += this.vx*dt;
    var foes2=state.entities.filter(function(e){return e.side!==this.side;}, this);
    for(var j=0;j<foes2.length;j++){
      var f2=foes2[j];
      if(Math.abs(f2.x-this.x)<14 && Math.abs(f2.y-this.y)<18){ dealDamage(f2,this.damage); this.dead=true; break; }
    }
    if(this.canHitTower){
      var t = (this.side==='P')? state.towers.E : state.towers.P;
      if(Math.abs(t.x-this.x)<26 && this.y>t.y-180){ dealDamage(t,this.damage); this.dead=true; }
    }
    if(this.x<-80||this.x>canvas.width+80) this.dead=true;
  };
  Projectile.prototype.draw=function(){
    if(this.kind==='fire' || this.kind==='fireB' || this.kind==='lightning' || this.kind==='fireSpell' || this.kind==='slowSpell'){
      ctx.save(); ctx.globalCompositeOperation='screen';

      if(this.kind==='lightning'){
        var gy = groundY(), hSpan = gy + 120, phase = clamp((this.y+120)/hSpan, 0, 1);
        var useImg=null, ready=false;
        if(phase < 0.33){ useImg = imgL1; ready=rL1; } else { useImg = imgL2; ready=rL2; }
        if(ready){ ctx.drawImage(useImg, this.x-28, this.y-43, 56, 86); }
        else{
          ctx.shadowBlur=18; ctx.shadowColor='#bfe8ff';
          ctx.strokeStyle='rgba(190,235,255,.95)'; ctx.lineWidth=3;
          ctx.beginPath(); ctx.moveTo(this.x, this.y-30); ctx.lineTo(this.x+8, this.y-10);
          ctx.lineTo(this.x-6, this.y-8); ctx.lineTo(this.x+4, this.y+10); ctx.stroke();
        }
        ctx.restore(); return;
      }

      if(this.kind==='fireSpell'){
        var gy2 = groundY(), hSpan2 = gy2 + 120, phase2 = clamp((this.y+120)/hSpan2, 0, 1);
        var useImgF=null, readyF=false;
        if(phase2 < 0.4){ useImgF = imgF1; readyF=rF1; } else { useImgF = imgF2; readyF=rF2; }
        if(readyF){ ctx.drawImage(useImgF, this.x-30, this.y-30, 60, 60); }
        else{ ctx.fillStyle='rgba(255,120,40,.9)'; ctx.beginPath(); ctx.arc(this.x, this.y, 12, 0, Math.PI*2); ctx.fill(); }
        ctx.restore(); return;
      }

      if(this.kind==='slowSpell'){
        var gy3 = groundY(), hSpan3 = gy3 + 120, phase3 = clamp((this.y+120)/hSpan3, 0, 1);
        var useImgS=null, readyS=false;
        if(phase3 < 0.4){ useImgS = imgS1; readyS=rS1; } else { useImgS = imgS2; readyS=rS2; }
        if(readyS){ ctx.drawImage(useImgS, this.x-28, this.y-28, 56, 56); }
        else{ ctx.fillStyle='rgba(150,210,255,.9)'; ctx.beginPath(); ctx.arc(this.x, this.y, 12, 0, Math.PI*2); ctx.fill(); }
        ctx.restore(); return;
      }

      // palle di fuoco unit√†
      var useBlue = (this.kind==='fireB');
      if(useBlue ? readyFireB : readyFire){ var im = useBlue ? imgFireB : imgFire; ctx.drawImage(im, this.x-24, this.y-24, 48, 48); }
      else{ ctx.fillStyle= useBlue ? 'rgba(90,170,255,.9)' : 'rgba(255,120,60,.9)'; ctx.beginPath(); ctx.arc(this.x, this.y, 10, 0, Math.PI*2); ctx.fill(); }
      ctx.restore(); return;
    }

    // bolt
    ctx.save(); ctx.globalCompositeOperation='screen';
    ctx.shadowBlur=10; ctx.shadowColor=(this.side==='P')? '#76faff':'#ff77aa';
    ctx.fillStyle=(this.side==='P')? '#bffcff':'#ffd0e0';
    ctx.fillRect(this.x-3, this.y-2, 6, 4);
    ctx.restore();
  };

  /* ===== Danni / livelli ===== */
  function dealDamage(target, dmg){
    if(target.max!==undefined){
      target.hp -= dmg;
      if(target.hp<=0){
        target.hp=0;
        if(target===state.towers.E && state.towers.P.hp>0){ nextLevel(); }
        else { endMatch(); }
      }
    }else{
      target.hp -= dmg;
      if (target.hp<=0) {
        target.hp = 0;
        if (target.side === 'E') state.energyP += 55; // energia per ogni nemico ucciso
      }
    }
  }

  function showLevelIntro(){
    var intro=document.getElementById('levelIntro');
    var title=document.getElementById('introTitle');
    var desc=document.getElementById('introDesc');
    title.textContent = 'LIVELLO ' + state.level;
    desc.textContent = 'Nuova ondata in arrivo‚Ä¶ preparati!';
    intro.style.display='flex';
    setTimeout(function(){ intro.style.display='none'; state.ai.timer = 0.2; spawnEnemy(); }, 1600);
  }

  function nextLevel(){
    state.level++;
    state.entities.length=0; state.projectiles.length=0; state.effects.length=0;

    state.towers.P.max += 400; state.towers.E.max += 400;
    state.towers.P.hp  = state.towers.P.max;
    state.towers.E.hp  = state.towers.E.max;

    state.incomeP*=1.12; state.incomeE*=1.14;
    state.ai.cadence = Math.max(1.8, state.ai.cadence*0.95);
    state.maxEnemies = Math.min(30, state.maxEnemies+2);
    state.energyP += 200;

    state.ai.timer=0; state.ai.spawnCount=0; state.paused=false;

    renderUpMenu(); updateSpellLabels(); renderMineMenu(); updateSpawnButtons(); updateMineButtons();
    updateHUD();
    showLevelIntro();
  }

  /* ===== Economia & Spawn ===== */
  function canAfford(c){ return state.energyP>=c; }
  function spend(c){ state.energyP=Math.max(0,state.energyP-c); }

  // costo evocazione unit√† dinamico
  function currentUnitCost(type){
    var base = Unit.types[type].cost || 0;
    var lvl  = state.unitUp[type] ? state.unitUp[type].lvl : 0;
    return Math.round(base * Math.pow(SPAWN_STEP, lvl));
  }

  // costo di CAST incantesimi (dipende dal livello dell‚Äôincantesimo)
  function currentSpellCost(key){
    var base = state.spells[key].cost;
    var lvl  = state.spells[key].lvl;
    return Math.round(base * Math.pow(SPELL_CAST_STEP, lvl));
  }

  function spawnPlayer(type){
    var cost=currentUnitCost(type); if(!canAfford(cost)) return;
    spend(cost); state.entities.push(new Unit('P',type)); pulseHUD(); updateHUD(); updateSpawnButtons();
  }

  function spawnEnemy(){
    var enemies=state.entities.filter(function(e){return e.side==='E';}).length;
    var slots=Math.max(0, state.maxEnemies - enemies); if(slots<=0) return;
    var lvl=state.level; var budget=clamp(50 + lvl*22 + rnd(-10,10), 50, 450);
    var remain=budget; var spawnedG=false; state.ai.spawnCount=(state.ai.spawnCount||0)+1; var spawned=0;
    while(remain>0 && spawned<slots){
      var roll=Math.random(); var t;
      if(roll < 0.65) t='EWarrior';
      else if(roll < 0.87) t='ECrossbow';
      else if(state.level>=6 && roll < 0.90) t='EGolemRoll';
      else if(state.level>=3 && roll < 0.94) t='EGolemPrime';
      else t='EGolem';

      var cost=Unit.types[t].cost || 60;
      if(remain-cost<0){ break; }
      state.entities.push(new Unit('E',t)); remain-=cost; spawned++; if(t==='EGolem'||t==='EGolemPrime'||t==='EGolemRoll') spawnedG=true;
    }
    if(!spawnedG && state.ai.spawnCount%6===0 && spawned<slots){ state.entities.push(new Unit('E','EGolem')); }
  }

  /* ===== Miniere ===== */
  const MINE_W = 64, MINE_H = 46, MINE_GAP = 12;
  function mineRowY(){ return groundY() + 32; }

  // POSIZIONAMENTO: subito a destra della torre sinistra, verso destra
  function minePos(index, total){
    const margin = 10;
    const baseLeft = state.towers.P.x + state.towers.P.w/2 + MINE_W/2 + 10; // vicino alla torre
    const maxRight = canvas.width - margin - MINE_W/2;
    let gap = MINE_GAP;
    while(baseLeft + index*(MINE_W+gap) > maxRight && gap>4){ gap -= 1; }
    const x = Math.min(baseLeft + index*(MINE_W+gap), maxRight);
    return { x, y: mineRowY(), gapUsed: gap };
  }

  function layoutMines(){
    for(let i=0;i<state.mines.length;i++){
      const p = minePos(i, state.mines.length);
      state.mines[i].x = p.x; state.mines[i].y = p.y;
      state.mines[i].w = MINE_W; state.mines[i].h = MINE_H;
    }
  }

  function updateMineButtons(){
    document.getElementById('placeMine').textContent = `‚õèÔ∏è Miniera (${state.minePlaceCost})`;
  }

  function addMine(){
    if(state.mines.length >= state.maxMines) return;
    var cost = state.minePlaceCost; if(!canAfford(cost)) return;
    spend(cost);
    state.mines.push({ level:0, timer:0, x:0, y:0, w:MINE_W, h:MINE_H });
    layoutMines();
    flashBanner('‚õèÔ∏è Miniera piazzata');
    updateHUD(); renderMineMenu();
  }

  function upgradeMine(i){
    var m = state.mines[i]; if(!m) return;
    if(m.level>=3) return;
    var nextIdx = m.level; var cost = state.mineCosts[nextIdx]; if(!canAfford(cost)) return;
    spend(cost);
    m.level += 1;
    flashBanner(`‚õèÔ∏è Miniera ${i+1} ‚Üí Lv${m.level}`);
    updateHUD(); renderMineMenu();
  }

  function MineBurst(x,y,amount){ this.x=x; this.y=y; this.amount=amount; this.t=0; this.dur=0.9; }
  MineBurst.prototype.update=function(dt){ this.t+=dt; };
  MineBurst.prototype.draw=function(){
    const k=Math.min(1,this.t/this.dur), up=18*k;
    ctx.save(); ctx.globalCompositeOperation='screen';
    ctx.globalAlpha=0.6*(1-k); ctx.beginPath(); ctx.arc(this.x, this.y-8-up, 14+10*(1-k), 0, Math.PI*2); ctx.fillStyle='rgba(0,229,255,.22)'; ctx.fill();
    ctx.globalAlpha=1.0*(1-k); ctx.font='700 16px Inter,system-ui,Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='rgba(0,229,255,.95)';
    ctx.fillText('üí∞ +'+this.amount, this.x, this.y-8-up); ctx.restore();
  };

  function updateMines(dt){
    for(let i=0;i<state.mines.length;i++){
      const m = state.mines[i]; m.timer += dt;
      if(m.timer>=5){
        m.timer -= 5;
        const rate = state.mineRates[m.level];
        state.energyP += rate;
        state.effects.push(new MineBurst(m.x, m.y- MINE_H/2, rate));
        pulseHUD();
      }
    }
  }

  function drawMines(){
    for(let i=0;i<state.mines.length;i++){
      const m=state.mines[i], img = (m.level===0?imgMine1:m.level===1?imgMine2:imgMine3), ready = (m.level===0?rM1:m.level===1?rM2:rM3);
      const x = m.x - MINE_W/2, y = m.y - MINE_H;
      if(ready){ ctx.drawImage(img, x, y, MINE_W, MINE_H); }
      else{ ctx.fillStyle='rgba(0,229,255,.28)'; ctx.fillRect(x, y, MINE_W, MINE_H); ctx.fillStyle='rgba(10,18,36,.9)'; ctx.fillRect(x+MINE_W*0.25, y+MINE_H*0.45, MINE_W*0.5, MINE_H*0.3); }
      ctx.save(); ctx.globalCompositeOperation='screen'; ctx.fillStyle='rgba(0,229,255,.12)'; ctx.fillRect(x+4, y+MINE_H+2, MINE_W-8, 8); ctx.restore();
    }
  }

  /* ===== HUD / Overlay ===== */
  var energyP=document.getElementById('energyP');
  var hpP=document.getElementById('hpP');
  var hpE=document.getElementById('hpE');
  var speedLbl=document.getElementById('speedLbl');
  var lvlLbl=document.getElementById('lvlLbl');
  function updateHUD(){
    energyP.textContent = Math.floor(state.energyP);
    hpP.textContent = Math.floor(state.towers.P.hp) + '/' + state.towers.P.max;
    hpE.textContent = Math.floor(state.towers.E.hp) + '/' + state.towers.E.max;
    speedLbl.textContent = state.speed.toFixed(0) + 'x';
    lvlLbl.textContent = '' + state.level;
  }
  function pulseHUD(){
    energyP.parentElement.animate([{transform:'scale(1)'},{transform:'scale(1.08)'},{transform:'scale(1)'}],{duration:220,easing:'ease-out'});
  }

  var overlay=document.getElementById('overlay');
  var endTitle=document.getElementById('endTitle');
  var endDesc=document.getElementById('endDesc');
  function showOverlay(){ overlay.style.display='flex'; }
  function hideOverlay(){ overlay.style.display='none'; }
  function endMatch(){
    state.paused=true;
    var victory=(state.towers.E.hp<=0 && state.towers.P.hp>0);
    endTitle.textContent = victory? 'VITTORIA ‚ú®' : 'SCONFITTA üí•';
    endDesc.textContent = victory ? ('Hai abbattuto la torre nemica al livello ' + state.level + '.') : ('La tua torre √® stata distrutta al livello ' + state.level + '.');
    showOverlay();
  }

  /* ===== Anteprima incantesimi (puntamento) ===== */
  function drawTargetPreview(){
    if(!state.targeting || state.aimX==null) return;
    var y = groundY();
    var spell = state.targeting.spell;
    var r = (spell==='fire') ? Math.floor(Unit.types.Wizard.range*2/3) : Unit.types.Wizard.range;

    ctx.save(); ctx.globalCompositeOperation='screen';
    var stroke, fill;
    if(spell==='lightning'){ stroke='rgba(150,220,255,.95)'; fill='rgba(90,160,255,.08)'; }
    else if(spell==='fire'){ stroke='rgba(255,160,60,.95)'; fill='rgba(255,120,40,.10)'; }
    else { stroke='rgba(150,210,255,.95)'; fill='rgba(120,190,255,.10)'; }
    ctx.strokeStyle=stroke; ctx.fillStyle=fill; ctx.lineWidth=2;
    ctx.beginPath(); ctx.arc(state.aimX, y, r, 0, Math.PI*2); ctx.fill(); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(state.aimX-12,y); ctx.lineTo(state.aimX+12,y); ctx.moveTo(state.aimX,y-12); ctx.lineTo(state.aimX,y+12); ctx.stroke();
    ctx.restore();
  }

  /* ===== Sfondo/Torri ===== */
  function drawBackground(){
    var w=canvas.width, h=canvas.height, ground=groundY();
    ctx.clearRect(0,0,w,h);
    if(bgReady){
      var sw=bgImg.width, sh=bgImg.height, scale=Math.max(w/sw, ground/sh), dw=sw*scale, dh=sh*scale, dx=(w-dw)/2, dy=ground-dh;
      ctx.save(); ctx.beginPath(); ctx.rect(0,0,w,ground); ctx.clip(); ctx.drawImage(bgImg, dx, dy, dw, dh); ctx.restore();
    }
    ctx.fillStyle='#0a1224'; ctx.fillRect(0, ground, w, h-ground);
    ctx.save(); ctx.globalCompositeOperation='lighter';
    ctx.strokeStyle='rgba(57,232,255,0.55)'; ctx.lineWidth=4; ctx.beginPath(); ctx.moveTo(40,ground); ctx.lineTo(w-40,ground); ctx.stroke(); ctx.restore();
  }
  function drawTower(t, side){
    var x=t.x, baseY=t.y, h=t.h, img=(side==='P')? tImgP:tImgE, ready=(side==='P')? tReadyP:tReadyE;
    if(ready){
      var scale = h / img.height, dw = img.width*scale, dh=h, dx=x-dw/2, dy=baseY-dh;
      ctx.save(); ctx.imageSmoothingEnabled=true; ctx.drawImage(img, dx, dy, dw, dh); ctx.restore();
    } else {
      ctx.save(); ctx.globalCompositeOperation='screen';
      ctx.shadowBlur=20; ctx.shadowColor=(side==='P')? '#7af0ff':'#ff9bc0';
      ctx.fillStyle=(side==='P')? '#44cfff':'#ff6fa3'; ctx.fillRect(x-22, baseY-h, 44, h*0.8); ctx.restore();
    }
    ctx.fillStyle='rgba(0,0,0,.25)'; ctx.fillRect(x-44, baseY-h-24, 88, 8);
    ctx.fillStyle=(side==='P')? '#20ffa8':'#ff7fa0'; ctx.fillRect(x-44, baseY-h-24, 88*(t.hp/t.max), 8);
  }

  /* ===== Loop ===== */
  function tick(now){
    var raw=(now-state.last)/1000; state.last=now;
    var dt=clamp(raw,0,1/15) * (state.paused?0:state.speed);
    state.dt=dt; state.time+=dt;

    // Flusso energia (senza decrescita)
    state.incomeFall = 1;

    updateMines(dt);

    state.ai.timer -= dt;
    while(state.ai.timer<=0){ spawnEnemy(); state.ai.timer += state.ai.cadence; }

    for(var i=0;i<state.entities.length;i++){ state.entities[i].update(dt); }
    state.entities = state.entities.filter(function(u){ return u.hp>0; });

    for(var j=0;j<state.projectiles.length;j++){ state.projectiles[j].update(dt); }
    state.projectiles = state.projectiles.filter(function(p){ return !p.dead; });

    for(j=0;j<state.effects.length;j++){ state.effects[j].update(dt); }
    state.effects = state.effects.filter(function(e){ return e.t < e.dur; });

    drawBackground();
    drawTower(state.towers.P,'P'); drawTower(state.towers.E,'E');
    layoutMines(); drawMines();
    for(j=0;j<state.projectiles.length;j++){ state.projectiles[j].draw(); }
    for(i=0;i<state.entities.length;i++){ state.entities[i].draw(); }
    for(j=0;j<state.effects.length;j++){ state.effects[j].draw(); }
    drawTargetPreview();

    updateHUD();
    requestAnimationFrame(tick);
  }

  /* ===== UI ===== */
  function updateSpawnButtons(){
    document.getElementById('spawnWarrior').textContent     = `üó°Ô∏è Guerriero (${currentUnitCost('Warrior')})`;
    document.getElementById('spawnCrossbow').textContent    = `üèπ Balestriere (${currentUnitCost('Crossbow')})`;
    document.getElementById('spawnGolem').textContent       = `üóø Golem (${currentUnitCost('Golem')})`;
    document.getElementById('spawnWizard').textContent      = `üßô‚Äç‚ôÇÔ∏è Mago (${currentUnitCost('Wizard')})`;
    document.getElementById('spawnBabyWizard').textContent  = `üßô‚Äç‚ôÇÔ∏è‚ú® Baby Mago Blu (${currentUnitCost('BabyWizard')})`;
  }
  document.getElementById('spawnWarrior').addEventListener('click', function(){ spawnPlayer('Warrior'); });
  document.getElementById('spawnCrossbow').addEventListener('click', function(){ spawnPlayer('Crossbow'); });
  document.getElementById('spawnGolem').addEventListener('click', function(){ spawnPlayer('Golem'); });
  document.getElementById('spawnWizard').addEventListener('click', function(){ spawnPlayer('Wizard'); });
  document.getElementById('spawnBabyWizard').addEventListener('click', function(){ spawnPlayer('BabyWizard'); });

  var barEl  = document.getElementById('bar');

  /* ===== Menu Potenziamenti (UNIT√Ä + GLOBALI + INCANTESIMI) ===== */
  var upMenu = document.getElementById('upMenu');

  function nextCost(type){ var info=UP[type], lvl=state.unitUp[type].lvl; return Math.floor(info.base*Math.pow(info.step,lvl)); }
  function globalCost(which){
    const base = (which==='dmg') ? 150 : 200;
    const step = (which==='dmg') ? 1.25 : 1.28;
    const t = (which==='dmg') ? state.globalUp.dmg : state.globalUp.inc;
    return Math.floor(base * Math.pow(step, t));
  }
  function spellNextCost(key){
    var info=SPELL_UP[key], lvl=state.spells[key].lvl;
    return Math.floor(info.base*Math.pow(info.step,lvl));
  }
  function currentDamage(type){
    const u = state.unitUp[type] || {dmg:1};
    return Unit.types[type].damage * u.dmg * state.dmgMulP;
  }
  function currentHp(type){
    const u = state.unitUp[type] || {hp:1};
    return Unit.types[type].hp * u.hp;
  }

  function openMenuAt(menu, anchorBtn){
    var r = anchorBtn.getBoundingClientRect();
    var parentR = barEl.getBoundingClientRect();
    menu.style.left = (r.left - parentR.left) + 'px';
    menu.style.top  = (r.bottom - parentR.top + 6) + 'px';
    menu.style.display='block';
    menu.setAttribute('aria-hidden','false');
  }
  function closeMenuEl(menu){ menu.style.display='none'; menu.setAttribute('aria-hidden','true'); }
  function toggleMenuAt(menu, anchorBtn){ (menu.style.display==='block')? closeMenuEl(menu): openMenuAt(menu,anchorBtn); }

  function renderUpMenu(){
    var html = '';

    function unitRow(key, label){
      const u = state.unitUp[key];
      const lvl = u.lvl;
      const costTxt = (lvl>=MAX_UNIT_LVL)? 'MAX' : nextCost(key);
      html += `<button class="item" data-unit="${key}" ${lvl>=MAX_UNIT_LVL?'aria-disabled="true"':''}>
        ${label} +12% DMG / +14% HP ‚Ä¢ Lv${lvl} (${costTxt})
        <span class="sub">HP: ${format(currentHp(key))} ‚Ä¢ DMG: ${format(currentDamage(key))}</span>
      </button>`;
    }
    unitRow('Warrior','Guerriero');
    unitRow('Crossbow','Balestriere');
    unitRow('Golem','Golem');
    unitRow('Wizard','Mago');
    unitRow('BabyWizard','Baby Mago Blu');

    html += '<hr/>';

    // Globali: +1%
    html += `<button id="upDmg" class="item">‚¨ÜÔ∏è Danno Globale +1% (${globalCost('dmg')})</button>`;
    html += `<button id="upInc" class="item">üíπ Entrate +1% (${globalCost('inc')})</button>`;

    html += '<hr/>';

    // INCANTESIMI dentro lo stesso menu
    function spellRow(key,label){
      const s = state.spells[key];
      const lvl = s.lvl;
      const costTxt = (lvl>=MAX_SPELL_LVL)? 'MAX' : spellNextCost(key);
      let sub='';
      if(key==='lightning'){
        sub = `Danno: ${Math.round(s.dmg * s.mul)} ‚Ä¢ Cast: ${currentSpellCost('lightning')}`;
      }else if(key==='fire'){
        const imp = Math.round(s.impact * s.mul);
        const dps = Math.round(s.dot * s.mul);
        sub = `Impatto: ${imp} ‚Ä¢ Brucia: ${dps}/s √ó ${s.dotDur + 2*lvl}s ‚Ä¢ Cast: ${currentSpellCost('fire')}`;
      }else{
        const effFactor = Math.max(0.2, s.factor * Math.pow(0.96, lvl));
        const effDur = s.dur + 2*lvl;
        sub = `Rallenta √ó${effFactor.toFixed(2)} ‚Ä¢ Durata: ${effDur}s ‚Ä¢ Cast: ${currentSpellCost('slow')}`;
      }
      html += `<button class="item" data-spell="${key}" ${lvl>=MAX_SPELL_LVL?'aria-disabled="true"':''}>
        ${label} +${Math.round(SPELL_UP[key].bonus*100)}% ‚Ä¢ Lv${lvl} (${costTxt})
        <span class="sub">${sub}</span>
      </button>`;
    }
    spellRow('lightning','‚ö° Fulmine');
    spellRow('fire','üî• Fuoco');
    spellRow('slow','üßä Gelo');

    upMenu.innerHTML = html;

    // bind unit
    upMenu.querySelectorAll('[data-unit]').forEach(function(btn){
      const key = btn.getAttribute('data-unit');
      btn.onclick = function(e){ e.stopPropagation(); upgradeUnit(key); };
    });
    // bind spell
    upMenu.querySelectorAll('[data-spell]').forEach(function(btn){
      const key = btn.getAttribute('data-spell');
      btn.onclick = function(e){ e.stopPropagation(); upgradeSpell(key); };
    });

    // bind globali
    var bD = upMenu.querySelector('#upDmg');
    var bI = upMenu.querySelector('#upInc');
    if(bD) bD.onclick = function(e){
      e.stopPropagation();
      const cost = globalCost('dmg'); if(!canAfford(cost)) return;
      spend(cost); state.dmgMulP = +(state.dmgMulP + 0.01).toFixed(6);
      state.globalUp.dmg++; flashBanner('Danno Globale +1%'); renderUpMenu(); updateHUD();
    };
    if(bI) bI.onclick = function(e){
      e.stopPropagation();
      const cost = globalCost('inc'); if(!canAfford(cost)) return;
      spend(cost); state.incomeMulP = +(state.incomeMulP + 0.01).toFixed(6);
      state.globalUp.inc++; flashBanner('Entrate +1%'); renderUpMenu(); updateHUD();
    };
  }

  function upgradeUnit(type){
    var obj=state.unitUp[type];
    if(obj.lvl>=MAX_UNIT_LVL){ flashBanner('Livello massimo raggiunto'); return; }
    var cost=nextCost(type); if(!canAfford(cost)) return;
    spend(cost);
    obj.lvl += 1;
    obj.dmg = +(obj.dmg * (1+UP[type].bonusD)).toFixed(6);
    obj.hp  = +(obj.hp  * (1+UP[type].bonusH)).toFixed(6);
    flashBanner((type==='BabyWizard'?'Baby Mago Blu':type)+' potenziato! (+DMG/+HP)');
    renderUpMenu(); updateHUD(); updateSpawnButtons();
  }

  function upgradeSpell(key){
    const s = state.spells[key];
    if(s.lvl>=MAX_SPELL_LVL){ flashBanner('Incantesimo al livello massimo'); return; }
    const cost = spellNextCost(key); if(!canAfford(cost)) return;
    spend(cost);
    s.lvl += 1;
    if(key!=='slow'){ s.mul = +(s.mul * (1+SPELL_UP[key].bonus)).toFixed(6); }
    flashBanner(`${(key==='lightning'?'Fulmine':key==='fire'?'Fuoco':'Gelo')} Lv${s.lvl}`);
    renderUpMenu(); updateSpellLabels(); updateHUD();
  }

  // pulsante menu potenziamenti
  var btnUpgrades = document.getElementById('btnUpgrades');
  btnUpgrades.addEventListener('click', function(e){ e.stopPropagation(); renderUpMenu(); toggleMenuAt(upMenu,this); });

  /* ===== Incantesimi: menu uso ===== */
  var spMenu = document.getElementById('spellMenu');

  function ensureSpellMenu(){
    if(spMenu.dataset.ready==='1') return;
    spMenu.dataset.ready='1';
    function make(id){
      const b=document.createElement('button');
      b.id=id; b.className='item';
      b.innerHTML = `<span class="label"></span><span class="sub"></span>`;
      spMenu.appendChild(b);
    }
    make('spLightning'); make('spFire'); make('spSlow');

    document.getElementById('spLightning').onclick=function(e){
      e.stopPropagation(); closeMenuEl(spMenu);
      if(state.level < state.spells.lightning.unlockLvl) return;
      var cost = currentSpellCost('lightning'); if(!canAfford(cost)) return;
      spend(cost); state.targeting = { spell:'lightning', cost:cost };
      state.aimX = null; canvas.classList.add('aim'); flashBanner('‚ö° Fulmine pronto ‚Äî tocca un punto'); updateHUD();
    };
    document.getElementById('spFire').onclick=function(e){
      e.stopPropagation(); closeMenuEl(spMenu);
      if(state.level < state.spells.fire.unlockLvl) return;
      var cost = currentSpellCost('fire'); if(!canAfford(cost)) return;
      spend(cost); state.targeting = { spell:'fire', cost:cost };
      state.aimX = null; canvas.classList.add('aim'); flashBanner('üî• Fuoco pronto ‚Äî tocca un punto'); updateHUD();
    };
    document.getElementById('spSlow').onclick=function(e){
      e.stopPropagation(); closeMenuEl(spMenu);
      if(state.level < state.spells.slow.unlockLvl) return;
      var cost = currentSpellCost('slow'); if(!canAfford(cost)) return;
      spend(cost); state.targeting = { spell:'slow', cost:cost };
      state.aimX = null; canvas.classList.add('aim'); flashBanner('üßä Gelo pronto ‚Äî tocca un punto'); updateHUD();
    };
  }

  function updateSpellLabels(){
    ensureSpellMenu();

    const b = document.getElementById('spLightning');
    const unlock2 = state.level >= state.spells.lightning.unlockLvl;
    b.setAttribute('aria-disabled', unlock2 ? 'false' : 'true');
    b.querySelector('.label').textContent = (unlock2 ? '‚ö° Fulmine' : '‚ö° Fulmine ‚Äî L2') + ` ‚Ä¢ (${currentSpellCost('lightning')})`;
    b.querySelector('.sub').textContent = `Danno ${Math.round(state.spells.lightning.dmg * state.spells.lightning.mul)} ‚Ä¢ Area = range Mago`;

    const f = document.getElementById('spFire');
    const unlock4 = state.level >= state.spells.fire.unlockLvl;
    f.setAttribute('aria-disabled', unlock4 ? 'false' : 'true');
    f.querySelector('.label').textContent = (unlock4 ? 'üî• Fuoco' : 'üî• Fuoco ‚Äî L4') + ` ‚Ä¢ (${currentSpellCost('fire')})`;
    const fireDps = Math.round(state.spells.fire.dot * state.spells.fire.mul);
    const fireImp = Math.round(state.spells.fire.impact * state.spells.fire.mul);
    f.querySelector('.sub').textContent = `Impatto ${fireImp} ‚Ä¢ AoE 2/3 ‚Ä¢ Brucia ${fireDps}/s per ${state.spells.fire.dotDur + 2*state.spells.fire.lvl}s`;

    const s = document.getElementById('spSlow');
    const unlock6 = state.level >= state.spells.slow.unlockLvl;
    s.setAttribute('aria-disabled', unlock6 ? 'false' : 'true');
    const effFactor = Math.max(0.2, state.spells.slow.factor * Math.pow(0.96, state.spells.slow.lvl));
    const effDur = state.spells.slow.dur + 2*state.spells.slow.lvl;
    s.querySelector('.label').textContent = (unlock6 ? 'üßä Gelo' : 'üßä Gelo ‚Äî L6') + ` ‚Ä¢ (${currentSpellCost('slow')})`;
    s.querySelector('.sub').textContent = `Rallenta √ó${effFactor.toFixed(2)} per ${effDur}s (area = range Mago)`;
  }
  document.getElementById('btnSpells').addEventListener('click', function(e){
    e.stopPropagation(); updateSpellLabels(); toggleMenuAt(spMenu,this);
  });

  /* ===== Puntamento incantesimi ‚Äî supporto TOUCH (pointer events) ===== */
  function setAimFromEvent(ev){
    const rect = canvas.getBoundingClientRect();
    state.aimX = clamp((ev.clientX || (ev.touches && ev.touches[0].clientX) || 0) - rect.left, 12, canvas.width-12);
  }
  canvas.addEventListener('pointermove', function(ev){ if(!state.targeting) return; setAimFromEvent(ev); ev.preventDefault(); }, {passive:false});
  canvas.addEventListener('pointerdown', function(ev){
    if(!state.targeting) return; ev.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = clamp(ev.clientX - rect.left, 12, canvas.width-12);
    if(state.targeting.spell==='lightning'){
      const dmg = state.spells.lightning.dmg * state.spells.lightning.mul * state.dmgMulP;
      const radius = Unit.types.Wizard.range;
      state.projectiles.push(new Projectile(x, -120, 0, 'P', dmg, 'lightning', false, { vy:1100, radius }));
    }else if(state.targeting.spell==='fire'){
      const dmg0 = state.spells.fire.impact * state.spells.fire.mul * state.dmgMulP;
      const radiusF = Math.floor(Unit.types.Wizard.range*2/3);
      state.projectiles.push(new Projectile(x, -120, 0, 'P', dmg0, 'fireSpell', false, { vy:900, radius: radiusF }));
    }else if(state.targeting.spell==='slow'){
      const radiusS = Unit.types.Wizard.range;
      state.projectiles.push(new Projectile(x, -120, 0, 'P', 0, 'slowSpell', false, { vy:900, radius: radiusS }));
    }
    state.targeting=null; state.aimX=null;
    canvas.classList.remove('aim');
  }, {passive:false});

  /* ===== Menu Miniere ===== */
  var mineMenu = document.getElementById('mineMenu');
  function renderMineMenu(){
    var html = '';
    if(state.mines.length===0){
      html += `<div class="item" aria-disabled="true">Nessuna miniera<span class="sub">Usa ‚Äú‚õèÔ∏è Miniera (${state.minePlaceCost})‚Äù per costruire</span></div>`;
    }else{
      for(var i=0;i<state.mines.length;i++){
        var m = state.mines[i];
        var nextCostTxt = (m.level>=3) ? 'MAX' : state.mineCosts[m.level] + '';
        var rate = state.mineRates[m.level];
        html += `<button class="item" data-idx="${i}" ${m.level>=3?'aria-disabled="true"':''}>
          ‚õèÔ∏è Miniera ${i+1} ‚Äî Lv${m.level} ‚Ä¢ ${m.level>=3?'‚Äî':('Up '+nextCostTxt)}
          <span class="sub">Rendimento: ${rate}/5s ‚Äî Pos: ${i+1}/${state.maxMines}</span>
        </button>`;
      }
    }
    mineMenu.innerHTML = html;
    mineMenu.querySelectorAll('button.item').forEach(function(btn){
      var i = +btn.getAttribute('data-idx');
      if(!isNaN(i)){ btn.onclick = function(e){ e.stopPropagation(); upgradeMine(i); }; }
    });
  }
  document.getElementById('btnMines').addEventListener('click', function(e){
    e.stopPropagation(); renderMineMenu(); toggleMenuAt(mineMenu, this);
  });
  document.getElementById('placeMine').addEventListener('click', function(){ addMine(); });

  /* ===== Chiusura menu click fuori ===== */
  document.addEventListener('click', function(e){
    if(upMenu.style.display==='block' && !upMenu.contains(e.target) && e.target!==btnUpgrades){ closeMenuEl(upMenu); }
    if(spMenu.style.display==='block' && !spMenu.contains(e.target) && e.target!==document.getElementById('btnSpells')){ closeMenuEl(spMenu); }
    if(mineMenu.style.display==='block' && !mineMenu.contains(e.target) && e.target!==document.getElementById('btnMines')){ closeMenuEl(mineMenu); }
  });

  /* ===== ESC (su mobile non utile ma manteniamo) ===== */
  document.addEventListener('keydown', function(e){
    if(e.key==='Escape'){
      closeMenuEl(upMenu); closeMenuEl(spMenu); closeMenuEl(mineMenu);
      if(state.targeting){
        state.energyP += state.targeting.cost;
        state.targeting=null; state.aimX=null; canvas.classList.remove('aim');
        flashBanner('Incantesimo annullato ‚Ä¢ ‚ö° rimborsati'); updateHUD();
      }
    }
  });

  /* ===== Controlli generali (ora fino a 4x) ===== */
  const spdBtn = document.getElementById('toggleSpeed');
  function setSpeed(v){
    state.speed = v;
    spdBtn.textContent = (v===1) ? '‚ö° 2x' : (v===2 ? '‚ö° 4x' : '‚ö° 1x');
    updateHUD();
  }
  spdBtn.addEventListener('click', function(){ setSpeed(state.speed===1 ? 2 : (state.speed===2 ? 4 : 1)); });
  document.getElementById('togglePause').addEventListener('click', function(){ state.paused = !state.paused; });
  document.getElementById('nextLvl').addEventListener('click', function(){ nextLevel(); });
  document.getElementById('restartBtn').addEventListener('click', function(){ reset(); });
  document.getElementById('contBtn').addEventListener('click', function(){ reset(); });

  /* ===== Banner ===== */
  function flashBanner(text){
    var el=document.createElement('div');
    el.textContent=text;
    el.style.position='absolute'; el.style.left='50%'; el.style.top='16%';
    el.style.transform='translate(-50%, -50%)';
    el.style.padding='10px 16px';
    el.style.border='1px solid rgba(255,255,255,.12)';
    el.style.borderRadius='14px';
    el.style.background='rgba(14,28,60,.9)';
    el.style.color='var(--text)'; el.style.fontWeight='800';
    el.style.boxShadow='0 10px 40px rgba(0,0,0,.5)'; el.style.zIndex='10'; el.style.opacity='0.0';
    wrap.appendChild(el);
    el.animate(
      [{opacity:0, transform:'translate(-50%,-50%) scale(.96)'},
       {opacity:1, transform:'translate(-50%,-50%) scale(1)'},
       {opacity:0, transform:'translate(-50%,-50%) scale(1.04)'}],
      {duration:1100, easing:'ease'}
    ).onfinish=function(){ el.remove(); };
  }

  /* ===== Avvio ===== */
  resize(); reset(); requestAnimationFrame(tick);
  </script>
</body>
</html>
